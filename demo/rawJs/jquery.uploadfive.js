(function(e,t,n){var r=t.document,i=t.navigator,s=t.location,o={NOT_ALLOW_SELECT:"不合法的文件将不被添加到队列中！",NOT_ALLOW_UPLOAD:"文件 ${fileName} 类型不合法，不允许上传！",REPLACE_FIlE_IN_QUEUE:"文件 ${fileName} 已存在队列中，是否继续添加？"},u={addEvent:function(e,t,n){e=e||r,r.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)},removeEvent:function(e,t,n){e=e||r,r.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent("on"+t,n)}},a={init:function(i){return this.each(function(){var s=this,u=e(this),h=u.parent(),p=u.clone();u.attr("id")||u.attr("id","uploadfive_"+(new Date).getTime());var d={id:u.attr("id")},v=e.extend({auto:!0,appendTo:!1,uploader:"",method:"POST",dataType:!1,formData:{},fileObjName:"Filedata",multi:!1,fileTypeExts:"*.*",queueID:!1,buttonText:"选择文件",buttonClass:"",buttonCursor:"pointer",removeCancelled:!0,removeCompleted:!0,removeTimeout:3,progressData:"percentage",itemTemplate:!1,dragField:!1},i,d),m={file_post_name:v.fileObjName,file_allow_ext:v.fileTypeExts,request_method:v.method,request_url:v.uploader,settings:v,method_upload_handler:a.upload,method_cancel_handler:a.cancel,file_queued_handler:f.onSelect,object_init_handler:v.onInit||n,upload_cancel_handler:f.onCancel,upload_error_handler:f.onUploadError,upload_progress_handler:f.onUploadProgress,upload_start_handler:f.onUploadStart,upload_success_handler:f.onUploadSuccess};t["uploadfive_"+v.id]=e.extend({},m);var g=t["uploadfive_"+v.id],y=l.initButtonText.call(g);u=e("#"+v.id),u.data("uploadfive",g);if(!v.queueID){var b=e("<div />",{id:v.id+"-queue","class":"uploadfive-queue"});u.after(b),g.settings.queueID=v.id+"-queue",g.settings.defaultQueue=!0}g.queueData=l.getDefaultQueueData(),g.original=p,g.queue=b||e("#"+v.queueID),e("#"+v.id+" #"+y).unbind(),e("#"+v.id+" #"+y).bind({"click.uploadfive":function(n){n=n||t.event;var r=e("#"+v.id);return c.runFunction(v.onDialogOpen,r,[n])},"change.uploadfive":function(){function a(){var f=t[i];if(c.allowUpload(f,v.fileTypeExts)){var l=!0;c.inQueue(f,g.queueData.files)&&(confirm(o.REPLACE_FIlE_IN_QUEUE.replace("${fileName}",f.name))||(l=!1)),l&&(r||(g.queueData.filesSelected++,r=!0),g.file_queued_handler.call(g,f))}else alert(o.NOT_ALLOW_UPLOAD.replace("${fileName}",f.name));i++,i>=n?(e(this).val(""),v.auto&&g.method_upload_handler.call(u)):setTimeout(a,s)}var t=this.files,n=t.length,r=!1,i=0,s=10;setTimeout(a,s)}}),v.dragField&&(e(r).on({dragleave:function(e){e.preventDefault()},drop:function(e){e.preventDefault()},dragenter:function(e){e.preventDefault()},dragover:function(e){e.preventDefault()}}),e(v.dragField)[0].addEventListener("drop",function(e){e.preventDefault();var t=e.dataTransfer.files;if(t.length==0)return!1;for(var n=0,r=t.length;n<r;++n){var i=t[n];if(!c.allowUpload(i,v.fileTypeExts))continue;i.dragFlag=!0,g.file_queued_handler.call(g,i)}},!1));var w=g.object_init_handler;w&&typeof w=="function"&&w.call(u,g)})},cancel:function(t,n){var r=arguments;return this.each(function(){var t=e(this),n=t.data("uploadfive"),i=n.settings,s=n.queue,o=r[0];if(o)if(o=="*"){var u=n.queueData.files,a=n.queueData.filesLength;for(var f in u)u.hasOwnProperty(f)&&l.cancelUpload.call(n,f,function(){s.find("#"+f+" .cancel").remove(),i.removeCancelled&&s.find("#"+f).fadeOut(i.removeTimeout*1e3,function(){e(this).remove()})});l.clearQueue.call(n,function(){c.runFunction(i.onClearQueue,t,[a])})}else l.cancelUpload.call(n,o,function(){s.find("#"+o+" .cancel").remove(),i.removeCancelled&&s.find("#"+o).fadeOut(i.removeTimeout*1e3,function(){e(this).remove()})});else{var h=s.children().eq(0);if(h>0)return!1;var p=h.attr("id");l.cancelUpload.call(n,p,function(){h.find(".cancel").remove(),i.removeCancelled&&h.fadeOut(i.removeTimeout*1e3,function(){e(this).remove()})})}})},settings:function(t,n){var r=arguments;this.each(function(){var i=e(this),s=i.data("uploadfive"),o=s.settings;if(r.length===1)return o[t];switch(t){case"auto":n=inArray(n,[!0,!1])>-1?n:!0;break;case"uploader":s.request_url=n;break;case"method":s.request_method=n;break;case"fileObjName":s.file_post_name=n;break;case"formData":n=e.extend(o.formData,n);break;case"multi":n=inArray(n,[!0,!1])>-1?n:!1;break;case"fileTypeExts":s.file_allow_ext=n;break;case"buttonText":e("#"+o.id+" span").html(n);break;case"buttonClass":e("#"+o.id).removeClass(o.buttonClass),e("#"+o.id).addClass(n);break;case"buttonCursor":e("#"+o.id).css("cursor",n);break;case"removeCancelled":n=inArray(n,[!0,!1])>-1?n:!0;break;case"removeCompleted":n=inArray(n,[!0,!1])>-1?n:!0;break;case"progressData":n=inArray(n,["percentage","speed"])>-1?n:"percentage"}o[t]=n})},upload:function(t){var n=arguments;return this.each(function(){var r=e(this),i=r.data("uploadfive"),s=i.settings,o=i.queueData;if(o.filesLength<=0&&!t)return!1;var u=i.queue;o.uploadQueue.length>0?l.loadUploadQueue.apply(i,n):(l.loadUploadQueue.apply(i,n),l.startUpload.call(i,o.uploadQueue.shift()||t))})}},f={onCancel:function(t){var n=this,r=this.settings,i=this.queueData,s=e("#"+r.id);c.runFunction(r.onCancel,s,[t]),l.uploadComplete.call(n,t)},onSelect:function(t){var n=this.settings,r=this.queueData,i=e("#"+n.id),s="FDUpload_"+n.id+"_"+(r.filesSelected-1)+"_"+r.filesLength,o=c.getFileInfos(t),u=e.extend({},t,{id:s,index:r.filesLength,filestatus:-1,type:o.type,original:t});r.filesLength++,r.queueSize+=t.size;var a=t.name,f={fileID:s,instanceID:n.id,fileFullName:a,fileName:a.length>20?a.substring(0,20)+"...":a,fileSize:o.size,fileType:o.type};n.itemTemplate||(n.itemTemplate='<div id="${fileID}" class="uploadfive-queue-item">                    <div class="cancel">                        <a title="取消" href="javascript:$(\'#${instanceID}\').uploadfive(\'cancel\', \'${fileID}\')">X</a>                    </div>                    <div class="information">                        <span title="${fileFullName}" class="fileName">${fileName} (${fileSize})</span><span class="data"></span>                        <div class="uploadfive-progress">                            <div class="uploadfive-progress-bar"><!--Progress Bar--></div>                        </div>                    </div>                </div>');var l=n.itemTemplate;for(var h in f)l=l.replace(new RegExp("\\$\\{"+h+"\\}","g"),f[h]);this.queue.append(l),r.files[s]=u,c.runFunction(n.onSelect,i,[u])},onUploadError:function(t){var n=this,r=this.settings,i=this.queueData,s=e("#"+r.id);l.setFileStatus(t,0),i.uploadsErrored++;var o=this.queue.find("#"+t.id);o.find(".data").html(" - Errored"),o.find(".uploadfive-progress-bar").css("width","1px"),o.find(".cancel").remove(),r.removeCompleted&&o.fadeOut(r.removeTimeout*1e3,function(){e(this).remove()}),c.runFunction(r.onUploadError,s,[t]),l.uploadComplete.call(n,t)},onUploadProgress:function(t,n,r){var i=this,s=this.settings,o=this.queueData,u=e("#"+s.id);if(l.getFileStatus(t)!=2)return!1;var a=(new Date).getTime(),f=a-this.timer;f>500&&(this.timer=a);var h=n-this.bytesLoaded;o.queueBytesUploaded+=n,this.bytesLoaded=n;var p=Math.round(n/r*100),d="KB/s",v=h*1024/(f*1e3);v=Math.floor(v*10)/10,o.averageSpeed>0?o.averageSpeed=Math.floor((o.averageSpeed+v)/2):o.averageSpeed=v;if(v>1e3){var m=Math.floor(v/1e3);o.averageSpeed=m,d="MB/s"}var g={percentage:p+"%",speed:o.averageSpeed+d},y=this.queue.find("#"+t.id);y.find(".data").html(" - "+(g[s.processData]||p+"%")),y.find(".uploadfive-progress-bar").css("width",p+"%"),c.runFunction(s.onUploadProgress,u,[t,n,r,o.queueBytesUploaded,o.queueSize])},onUploadStart:function(t){var n=this,r=this.settings,i=this.queueData,s=e("#"+r.id);this.timer=(new Date).getTime(),this.bytesLoaded=0;var o=i.files[t];l.setFileStatus(o,2),c.runFunction(r.onUploadStart,s,[o])},onUploadSuccess:function(t,n){var r=this,i=this.settings,s=this.queueData,o=e("#"+i.id);l.setFileStatus(t,1),s.uploadsSuccessful++,s.queueBytesUploaded+=t.size;var u=this.queue.find("#"+t.id);u.find(".data").html(" - Completed"),u.find(".cancel").remove(),i.removeCompleted&&u.fadeOut(i.removeTimeout*1e3,function(){e(this).remove()}),c.runFunction(i.onUploadSuccess,o,[t,n]),l.uploadComplete.call(r,t)}},l={initButtonText:function(){var t=this.settings,n=t.fileTypeExts=="*.*"?"":' accept="'+t.fileTypeExts.replace(/\*\./ig,".")+'"',r="uploadfive_"+t.id,i='<span class="uploadfive-button '+t.buttonClass+'" style="cursor:'+t.buttonCursor+';" id="'+t.id+'">'+"<span>"+t.buttonText+"</span>"+'<input title="点击选择文件" type="file"'+n+' id="'+r+'" name="'+r+'" '+(t.multi?'multiple="multiple"':"")+" />"+"</span>";return t.appendTo?e("#"+t.id).append(i):e("#"+t.id).replaceWith(i),r},startUpload:function(n){var r=this,i=this.settings,s=r.queueData;r.upload_start_handler.call(this,n);var o=s.files[n],a=s.files[n],f=new FormData;f.append(i.fileObjName,o.original);for(var c in i.formData)i.formData.hasOwnProperty(c)&&f.append(c,i.formData[c]);e.ajax({url:r.request_url,type:r.request_method,data:f,contentType:!1,processData:!1,dataType:i.dataType,xhr:function(){var i=e.ajaxSettings.xhr();return s.xhrs[n]=i,u.addEvent(i.upload,"progress",function(e){var n=e||t.event,i=n.loaded||0,s=n.total||a.size;r.upload_progress_handler.call(r,a,i,s)}),u.addEvent(i,"abort",function(e){var n=e||t.event;r.upload_cancel_handler.call(r,a)}),i},success:function(e){r.upload_success_handler.call(r,a,e)},error:function(){l.getFileStatus(a)==2&&r.upload_error_handler.call(r,a)}})},cancelUpload:function(e,t){var r=this,i=this.settings,s=this.queueData,o=s.files[e];if(o===n)return!1;if(c.inArray(l.getFileStatus(o),[-1,2])>-1){r.queue.find("#"+e+" .data").html(" - Cancelled"),r.queue.find("#"+e+" .uploadfive-progress-bar").css("width","1px"),l.setFileStatus(o,3),s.uploadsCancelled++;var u=c.inArray(e,s.uploadQueue);if(u>-1){var a=s.uploadQueue;s.uploadQueue=[].concat(a.slice(0,u),a.slice(u+1,a.length))}var f=s.xhrs[e];f?f.abort():r.upload_cancel_handler.call(this,o)}c.runFunction(t)},clearQueue:function(t){var n=this,r=this.settings,i=n.queueData.filesSelected;n.queueData=l.getDefaultQueueData(),n.queueData.filesSelected=i,r.removeCancelled&&n.queue.find(".uploadfive-queue-item").fadeOut(r.removeTimeout*1e3,function(){e(this).remove()}),n.timer=0,delete n.timer,n.bytesLoaded=0,delete n.bytesLoaded,c.runFunction(t)},getDefaultQueueData:function(){var e={files:{},filesSelected:0,filesLength:0,averageSpeed:0,queueBytesUploaded:0,queueSize:0,uploadSize:0,uploadQueue:[],uploadsSuccessful:0,uploadsErrored:0,uploadsCancelled:0,xhrs:{}};return e},loadUploadQueue:function(e){var t=this,n=t.queueData,r=[],i=0;e=e||"*";var s=n.files,o=null;if(e&&typeof e=="string")if(e=="*")for(var u in s)o=s[u],o.filestatus==-1&&(i+=o.size,r.push(o.id));else o=s[e],o&&o.filestatus==-1&&(i+=o.size,r.push(e));else{var a=e;for(var u=0;u<a;u++)o=s[e[u]],o&&o.filestatus==-1&&(i+=o.size,r.push(o.id))}return n.uploadSize=i,n.uploadQueue=r,r},getFileStatus:function(e){return e.filestatus},setFileStatus:function(e,t){e.filestatus=t},uploadComplete:function(t){var n=this,r=this.settings,i=this.queueData,s=e("#"+r.id);c.runFunction(r.onUploadComplete,s,[t]),i.uploadQueue.length>0&&c.runFunction(l.startUpload,n,[i.uploadQueue.shift()]),i.filesLength==i.uploadsSuccessful+i.uploadsErrored+i.uploadsCancelled&&(c.runFunction(r.onQueueComplete,s,[{uploadsSuccessful:i.uploadsSuccessful,uploadsErrored:i.uploadsErrored,uploadsCancelled:i.uploadsCancelled}]),r.removeCompleted?c.runFunction(l.clearQueue,this):e.extend(i,{filesLength:0,averageSpeed:0,queueBytesUploaded:0,queueSize:0,uploadSize:0,uploadQueue:[],uploadsSuccessful:0,uploadsErrored:0,uploadsCancelled:0}))}},c={typeOf:function(e){var t=Object.prototype.toString.call(e);return/\[object\s+(.*)\]/ig.exec(t)[1].toLowerCase()},allowUpload:function(t,n){var r=n.split(",");for(var i=r.length-1;i>-1;i--)r[i]="("+e.trim(r[i].replace(".","\\.").replace("*",".*"))+"$)";return r=r.join("|"),(new RegExp(r,"ig")).test(t.name)},cleckQueueExts:function(e,t){var n=e.length;for(var r=e.length;r>-1;r--)if(!this.allowUpload(e,t))return!0;return!1},computeFileSize:function(e,t){return t=t||2,e>1099511627776?(e/=1099511627776,e=(""+e).indexOf(".")>-1?e.toFixed(t):e,e+"TB"):e>1073741824?(e/=1073741824,e=(""+e).indexOf(".")>-1?e.toFixed(t):e,e+"GB"):e>1048576?(e/=1048576,e=(""+e).indexOf(".")>-1?e.toFixed(t):e,e+"MB"):e>1024?Math.round(e/1024)+"KB":Math.round(e)+"Byte"},getFileInfos:function(e){var t=e.name.lastIndexOf(".");return t>-1?{name:e.name.substring(0,t)||"未命名文件",type:e.name.substring(t)||"未知格式",size:this.computeFileSize(e.size)}:{}},inArray:function(t,n){if(e.inArray)return e.inArray(t,n);for(var r=n.length-1;r>-1;r--)if(n[r]==t)return r;return-1},isFunction:function(e){return e&&typeof e=="function"?!0:!1},runFunction:function(e,n,r){if(this.isFunction(e)){var i=arguments,s=i.length;if(s==1)return e.apply(t);if(s==2)return this.typeOf(n)=="array"?e.apply(t,n):e.apply(n);if(s==3)return e.apply(n||t,r)}},inQueue:function(e,t){for(var n in t)if(t.hasOwnProperty(n)&&e.name==t[n].name&&t[n].filestatus==-1&&e.size==t[n].size)return t[n].id;return!1}};e.fn.uploadfive=function(t){if(a[t])return a[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return a.init.apply(this,arguments);e.error("方法 "+t+" 在$.uploadfive中未定义！")}})(jQuery,window,undefined);